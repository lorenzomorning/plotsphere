---
title: "Purpose of package plotsphere"
author: "Lorenz Beck"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Use plotsphere}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  \usepackage[utf8]{inputenc}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  results = "asis",
  collapse = TRUE,
  comment = "#>")
options(rmarkdown.html_vignette.check_title = FALSE)
```

```{r setup, echo=FALSE, include=FALSE}
library(plotsphere)
library(rgl)
library(sf)
library(lwgeom)
setupKnitr(autoprint = TRUE)
```

The main use of plotsphere so far is the comparison between spatial geometries that are spherical and spatial geometries that emerge from two-dimensional referecen systems. 
The simple feature package `sf` is now capable of performing spatial operations of geographical/ellipsoidal coordinates (lon lat on WGS 84 for example) on a sphere, rather than most GISystems that handle geographical/ellipsoidal coordinates on a flat 2D space. The differences are huge and can be visualized very easy now using this package `plotsphere`

## Berlin 2 Tokyo

To demonstrate simple but huge differences in spatial lines, we define a line going from Berlin `(13.378936, 52.516658)` to Tokio `(139.753358, 35.681306)` on `WGS84 EPSG:4326`. 

```{r line}
# Berlin
berlin <- c(13.378936, 52.516658)
berlin_sf <- st_sfc(st_point(berlin), crs=4326)
#Tokyo
tokyo <- c(139.753358, 35.681306)
tokyo_sf <- st_sfc(st_point(tokyo), crs=4326)
# Line between berlin and tokyo
berlin2tokyo <- st_linestring(rbind(berlin, tokyo)) %>% st_sfc(crs = 4326)
```

To show where the lines really go we will now segmentize it on a shpere with `sf_use_s2 = TRUE` and simulate a traditional GIS by transforming the line to equirectangular projection (eqrc prj) which maps longitude and latitude linearly to the x and y axis and segmentize it with `sf_use_s2 = FALSE`

```{r segmentize, fig.dim = c(7, 5)}
# check is sf uses calculations on a sphere
sf_use_s2()
if (sf_use_s2()==FALSE) {
  sf_use_s2(TRUE)
}
berlin2tokyo_s2_seg <- st_segmentize(berlin2tokyo, 1000000)

# transform the original line to equirectangular projection (eqrc prj)
berlin2tokyo_eqc <- st_transform(berlin2tokyo, "+proj=eqc")
berlin2tokyo_r2_seg <- st_segmentize(berlin2tokyo_eqc, 1000000)

# plot both lines on a 2D plot
plot(st_transform(berlin2tokyo_s2_seg, "+proj=eqc"), axes = TRUE, col='darkblue')
plot(berlin2tokyo_r2_seg, add=TRUE, col='darkred')
# add labels for the lines
text(x=8000000, y=8000000, label='shorest distance on the sphere', col='darkblue', cex=0.8)
text(x=8000000, y=4500000, label='shorest distance on the eqrc prj', col='darkred', srt=-7, cex=0.8)

title(main='Line comparison on the equirectangular projection', xlab='X-Axis in meter', ylab='Y-Axis in meter')
# add labels for the cities
text(x=st_coordinates(berlin2tokyo_eqc)[1:2,1], y=st_coordinates(berlin2tokyo_eqc)[1:2,2]-500000, labels=c('Berlin', 'Tokyo'))
```

Looking at the 2D plot we clearly think that the straight line here is shorter.
But now we can also visualize it on a sphere
```{r sphere}
ps_globe(alpha=0.4)
ps_lines(berlin2tokyo_s2_seg, color='darkblue')
ps_lines(berlin2tokyo_r2_seg, color='darkred')
ps_points(berlin_sf)
ps_points(tokyo_sf)
berlin_coord <- st_transform(berlin_sf, "+proj=geocent") %>% st_coordinates()
text3d(x=berlin_coord[1,1], y=berlin_coord[1,2], z=berlin_coord[1,3], 'Berlin')
tokyo_coord <- st_transform(tokyo_sf, "+proj=geocent") %>% st_coordinates()
text3d(x=tokyo_coord[1,1], y=tokyo_coord[1,2], z=tokyo_coord[1,3], 'Tokyo')
```

Here we already get the impression that the line more south (the straight line in 2D) is not shorter than the great circle line on the sphere which passes by closer to the north pole.

This gets even more evident looking at the length of both lines
```{r length}
# on a sphere
st_length(berlin2tokyo_s2_seg)
# on r2 equirectangular projection
st_length(berlin2tokyo_r2_seg)
```
